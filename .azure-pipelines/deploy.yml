parameters:
- name: platformKeyVaultCreateMode
  type: string
  default: recover
  values:
  - 'recover'
  - 'default'
- name: nugetKeyVaultCreateMode
  type: string
  default: recover
  values:
  - 'recover'
  - 'default'

trigger: none
pr: none

pool: 'Dedicated'

resources:
  pipelines:
  - pipeline: platform-strategic-services.Validate
    source: platform-strategic-services.Validate
    trigger:
      branches:
        include:
        - main

stages: 
- stage: DeployPrdPlatform
  jobs:

  - deployment: DeployPrdPlatformKeyVaultBicep
    environment: 'platform-strategic-services'

    strategy:
      runOnce:
        deploy:
          steps:
            - task: AzureCLI@2
              displayName: DeployServicesBicep
              inputs:
                azureSubscription: 'spn-ado-Personal-Public-strategic-prd'
                scriptType: 'pscore'
                scriptLocation: 'inlineScript'
                inlineScript: |
                    az deployment sub create `
                      --template-file bicep/platformKeyVault.bicep `
                      --location 'uksouth' `
                      --parameters @params/platformKeyVault.prd.json `
                        parPlatformKeyVaultCreateMode='${{ parameters.platformKeyVaultCreateMode }}' `
                        parNugetKeyVaultCreateMode='${{ parameters.nugetKeyVaultCreateMode }}'

            - task: AzureCLI@2
              displayName: SetSqlServerAdminCredentials
              inputs:
                azureSubscription: 'spn-ado-Personal-Public-strategic-prd'
                scriptType: 'pscore'
                scriptLocation: 'scriptPath'
                arguments: '"prd" "uksouth"'
                addSpnToEnvironment: true
                scriptPath: '$(Build.sourcesDirectory)/.azure-pipelines/scripts/SetSqlServerAdminCredentials.ps1'

            - task: AzureCLI@2
              displayName: CreateDatabaseAADGroups
              inputs:
                azureSubscription: 'spn-ado-Personal-Public-strategic-prd'
                scriptType: 'pscore'
                scriptLocation: 'scriptPath'
                arguments: '"prd"'
                addSpnToEnvironment: true
                scriptPath: '$(Build.sourcesDirectory)/.azure-pipelines/scripts/CreateDatabaseAADGroups.ps1'

  - deployment: DeployPrdPlatformBicep
    dependsOn: [DeployPrdPlatformKeyVaultBicep]
    environment: 'platform-strategic-services'

    strategy:
      runOnce:
        deploy:
          steps:
            - task: AzureCLI@2
              displayName: DeployPrdPlatformBicep
              inputs:
                azureSubscription: 'spn-ado-Personal-Public-strategic-prd'
                scriptType: 'pscore'
                scriptLocation: 'inlineScript'
                inlineScript: |
                  $sqlAdminOid = (az ad group show --group "sg-sql-platform-prd-admins" --query 'id')  | ConvertFrom-Json

                  az deployment sub create `
                    --template-file bicep/platform.bicep `
                    --location 'uksouth' `
                    --parameters @params/platform.prd.json `
                      parSqlAdminOid=$sqlAdminOid

  - job: DeployPrdPlatformPermissions
    dependsOn: [DeployPrdPlatformBicep]
    steps:
      - task: AzureCLI@2
        displayName: CreateSqlServerRoleAssignment
        inputs:
          azureSubscription: 'spn-ado-Personal-Public-strategic-prd'
          scriptType: 'pscore'
          scriptLocation: 'scriptPath'
          arguments: '"sql-platform-prd-uksouth" "rg-platform-sql-prd-uksouth"'
          scriptPath: '$(Build.sourcesDirectory)/.azure-pipelines/scripts/CreateSqlServerRoleAssignment.ps1'