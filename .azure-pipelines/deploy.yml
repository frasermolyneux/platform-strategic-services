trigger: none

pool: 'Dedicated'

resources:
  pipelines:
  - pipeline: platform-strategic-services.Validate
    source: platform-strategic-services.Validate
    trigger: true

stages: 
- stage: DeployPrdPlatform
  jobs:
  - job: DeployPrdPlatformKeyVaultBicep
    steps:
    - task: AzureCLI@2
      displayName: DeployServicesBicep
      inputs:
        azureSubscription: 'spn-ado-Personal-Public-strategic-prd'
        scriptType: 'pscore'
        scriptLocation: 'inlineScript'
        inlineScript: |
            az deployment sub create `
              --template-file bicep/platformKeyVault.bicep `
              --location 'uksouth' `
              --parameters @params/platformKeyVault.prd.json

    - task: AzureCLI@2
      displayName: SetSqlServerAdminCredentials
      inputs:
        azureSubscription: 'spn-ado-Personal-Public-strategic-prd'
        scriptType: 'pscore'
        scriptLocation: 'scriptPath'
        arguments: '"prd" "uksouth"'
        addSpnToEnvironment: true
        scriptPath: '$(Build.sourcesDirectory)/.azure-pipelines/scripts/SetSqlServerAdminCredentials.ps1'

    - task: AzureCLI@2
      displayName: CreateDatabaseAADGroups
      inputs:
        azureSubscription: 'spn-ado-Personal-Public-strategic-prd'
        scriptType: 'pscore'
        scriptLocation: 'scriptPath'
        arguments: '"prd"'
        addSpnToEnvironment: true
        scriptPath: '$(Build.sourcesDirectory)/.azure-pipelines/scripts/CreateDatabaseAADGroups.ps1'

  - job: DeployPrdPlatformBicep
    dependsOn: [DeployPrdPlatformKeyVaultBicep]
    steps:
      - task: AzureCLI@2
        displayName: DeployPrdPlatformBicep
        inputs:
          azureSubscription: 'spn-ado-Personal-Public-strategic-prd'
          scriptType: 'pscore'
          scriptLocation: 'inlineScript'
          inlineScript: |
            $sqlAdminOid = (az ad group show --group "sg-sql-platform-$(environment)-admins" --query 'id')  | ConvertFrom-Json

            az deployment sub create `
              --template-file bicep/platform.bicep `
              --location 'uksouth' `
              --parameters @params/platform.prd.json `
                parSqlAdminOid=$(sqlAdminOid)
