parameters:
- name: azureSubscription
  type: string
- name: environment
  type: string
- name: environmentName
  type: string
- name: environmentTag
  type: string


stages:
- stage: Deploy${{ parameters.environmentName }}

  jobs:
  - deployment: Deploy${{ parameters.environmentName }}PlatformKeyVaultBicep
    environment: ${{ parameters.environment }}

    workspace:
      clean: all

    strategy:
      runOnce:
        deploy:
          steps:
            - checkout: self

            - task: AzureCLI@2
              displayName: Deploy${{ parameters.environmentName }}PlatformKeyVaultBicep
              inputs:
                azureSubscription: ${{ parameters.azureSubscription }}
                scriptType: 'pscore'
                scriptLocation: 'inlineScript'
                inlineScript: |
                  $deletedKeyVaults = az keyvault list-deleted --query '[].properties.vaultId' | ConvertFrom-Json
                  $isDeleted = $deletedKeyVaults | where {$_ -match 'rg-platform-keyvault-*.*-${{ parameters.environmentTag }}-uksouth'}

                  $keyVaultCreateMode = "default"
                  if ($isDeleted -ne $null) {
                    # To allow the environments to be torn-down and re-created, the Key Vault Create Mode must be set to 'recover'.
                    $keyVaultCreateMode = "recover"
                  }
                  
                  az deployment sub create `
                    --name 'strategicKeyVault${{ parameters.environmentName }}' `
                    --template-file bicep/platformKeyVault.bicep `
                    --location 'uksouth' `
                    --parameters @params/platformKeyVault.${{ parameters.environmentTag }}.json `
                      parPlatformKeyVaultCreateMode=$keyVaultCreateMode

  - job: Execute${{ parameters.environmentName }}PlatformKeyVaultScripts
    dependsOn: ['Deploy${{ parameters.environmentName }}PlatformKeyVaultBicep']

    workspace:
      clean: all

    steps:
      - checkout: self

      - task: AzureCLI@2
        displayName: SetSqlServerAdminCredentials
        inputs:
          azureSubscription: ${{ parameters.azureSubscription }}
          scriptType: 'pscore'
          scriptLocation: 'scriptPath'
          addSpnToEnvironment: true
          inlineScript: |
            $keyVaultName = az deployment sub show --name strategicKeyVault${{ parameters.environmentName }} --query properties.outputs.keyVaultName.value

            $secretName = "sql-platform-${{ parameters.environmentTag }}-uksouth-admin-password"
            if ($null -eq (az keyvault secret show --vault-name $keyVaultName --name $secretName)) {
                $password = ("abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!Â£$%^&*()".tochararray() | Sort-Object { Get-Random })[0..18] -join ''
                az keyvault secret set --name "$secretName" --vault-name $keyVaultName --value "$password" --description 'text/plain' | Out-Null
                az keyvault secret set --name "sql-platform-${{ parameters.environmentTag }}-uksouth-admin-username" --vault-name $keyVaultName --value "sql-platform-${{ parameters.environmentTag }}-uksouth-addy" --description 'text/plain' | Out-Null
            }

      - task: AzureCLI@2
        displayName: CreateDatabaseAADGroups
        inputs:
          azureSubscription: ${{ parameters.azureSubscription }}
          scriptType: 'pscore'
          scriptLocation: 'scriptPath'
          arguments: '"${{ parameters.environmentTag }}"'
          addSpnToEnvironment: true
          scriptPath: '$(Build.sourcesDirectory)/.azure-pipelines/scripts/CreateDatabaseAADGroups.ps1'

  - deployment: Deploy${{ parameters.environmentName }}PlatformBicep
    dependsOn: ['Execute${{ parameters.environmentName }}PlatformKeyVaultScripts']
    environment: ${{ parameters.environment }}

    workspace:
      clean: all

    strategy:
      runOnce:
        deploy:
          steps:
            - checkout: self

            - task: AzureCLI@2
              displayName: Deploy${{ parameters.environmentName }}ServicesBicep
              inputs:
                azureSubscription: ${{ parameters.azureSubscription }}
                scriptType: 'pscore'
                scriptLocation: 'inlineScript'
                inlineScript: |
                  $sqlAdminOid = (az ad group show --group "sg-sql-platform-${{ parameters.environmentTag }}-admins" --query 'id')  | ConvertFrom-Json

                  az deployment sub create `
                    --name 'strategicPlatform${{ parameters.environmentName }}' `
                    --template-file bicep/platform.bicep `
                    --location 'uksouth' `
                    --parameters @params/platform.${{ parameters.environmentTag }}.json `
                      parSqlAdminOid=$sqlAdminOid
